# Satisfactory Dashboard - Frontend

This document provides guidance for working with the React frontend application.

## Overview

React-based dashboard for monitoring Satisfactory factory operations. Features real-time data visualization with charts, interactive maps, and live updates via Server-Sent Events.

## Tech Stack

- **Bun 1.3** for package management and runtime
- **React 18** with TypeScript 5.6
- **Vite 5** for build and dev server
- **Tailwind CSS v4** for utility-first styling
- **shadcn/ui** for UI components (Radix UI primitives)
- **React Router 6** for client-side routing
- **Recharts** for data visualization
- **Leaflet + React Leaflet** for interactive maps
- **Lucide React** for icons (shadcn default)
- **@iconify/react** for additional icons
- **Day.js** for date formatting
- **oxlint** for linting
- **oxfmt** for code formatting

## Architecture

### Directory Structure

```
dashboard/src/
├── pages/                    # Page components (home, map, production, power, trains, drones, players, settings)
├── components/               # Reusable components
│   ├── ui/                  # shadcn UI components (Button, Card, Dialog, etc.)
│   ├── gauge/               # Gauge wrapper for react-gauge-component
│   ├── iconify/             # Iconify icon integration
│   ├── label/               # Custom Label component with Tailwind variants
│   ├── loading/             # Loading components (PageLoading, Spinner)
│   ├── logo/                # App logo component
│   ├── session-dialog/      # Add session dialog
│   ├── session-selector/    # Session dropdown selector
│   ├── session-status-bar/  # Session status indicator
│   ├── timeline/            # Custom Timeline component
│   ├── welcome/             # Welcome screen for new users
│   ├── theme-provider.tsx   # Dark/light theme context
│   └── mode-toggle.tsx      # Theme toggle component
├── contexts/                 # React Context
│   ├── api/                 # API data provider (SSE streaming)
│   └── sessions/            # Session management context
├── layouts/                  # Layout components
│   ├── dashboard/           # Main dashboard layout (sidebar, header)
│   └── simple/              # Simple layouts (no sidebar)
├── lib/                      # Utility functions
│   └── utils.ts             # cn() helper for Tailwind class merging
├── routes/                   # Routing configuration
│   ├── components/          # Route-level components
│   └── hooks/               # Routing hooks
├── sections/                 # Feature sections (page-specific components)
│   ├── drones/              # Drone views
│   ├── error/               # Error pages
│   ├── map/                 # Map views
│   ├── overview/            # Overview/dashboard views
│   ├── players/             # Player views
│   ├── power/               # Power circuit views
│   ├── production/          # Production views
│   ├── settings/            # Settings views
│   └── trains/              # Train views
├── services/                 # API services (session CRUD)
├── hooks/                    # Custom React hooks
└── utils/                    # Utility functions (formatting, abbreviations)
```

## Development Workflow

### Running the Dev Server

```bash
bun run dev          # Start Vite dev server (port 3039)
bun run dev:host     # Dev server with host binding (for network access)
```

### Building

```bash
bun run build        # TypeScript check + production build
```

Output: `dist/` directory

### Code Quality

```bash
bun run lint         # oxlint check
bun run lint:fix     # oxlint auto-fix
bun run format       # oxfmt format check
bun run format:fix   # oxfmt format and write
bun run check        # Full check (oxlint + oxfmt)
bun run check:fix    # Fix all (oxlint + oxfmt)
```

## Key Development Patterns

### Type Safety

Use auto-generated types from backend:

```tsx
import { Circuit, Drone, Train, Player, Session } from '../apiTypes';

interface Props {
    circuits: Circuit[];
    drones: Drone[];
}
```

Types generated by `tygo` from Go structs. Run `make generate` from project root after backend model changes.

### Session Context

Multi-session support via SessionContext:

```tsx
import { useSession } from 'src/contexts/sessions';

const MyComponent = () => {
    const { sessions, selectedSession, selectSession, createSession } = useSession();

    return (
        <div>
            <p>Current: {selectedSession?.name}</p>
            <button onClick={() => selectSession(sessions[0].id)}>
                Switch Session
            </button>
        </div>
    );
};
```

### API Context

Data fetching via React Context with session-scoped SSE:

```tsx
import { useContextSelector } from 'use-context-selector';
import { ApiContext } from 'src/contexts/api/useApi';

const MyComponent = () => {
    const api = useContextSelector(ApiContext, (v) => ({
        circuits: v.circuits,
        isLoading: v.isLoading,
        isOnline: v.isOnline,
    }));

    if (api.isLoading) return <Spinner />;
    if (!api.isOnline) return <Alert variant="destructive">Offline</Alert>;

    return <DataDisplay data={api.circuits} />;
};
```

### SSE Integration

Real-time updates via Server-Sent Events (session-scoped):

```tsx
// ApiProvider connects to /v1/sessions/{sessionId}/events
// and updates context automatically
```

### shadcn UI Components

Use shadcn components with Tailwind styling:

```tsx
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

const MyComponent = () => {
    return (
        <Card className="bg-card">
            <CardHeader>
                <CardTitle>Title</CardTitle>
            </CardHeader>
            <CardContent className="flex gap-4">
                <Button variant="default">Primary</Button>
                <Button variant="outline">Secondary</Button>
            </CardContent>
        </Card>
    );
};
```

### Tailwind Class Merging

Use the `cn()` utility for conditional and merged classes:

```tsx
import { cn } from '@/lib/utils';

const MyComponent = ({ active }: { active: boolean }) => {
    return (
        <div className={cn(
            "p-4 rounded-lg border",
            active && "border-primary bg-accent"
        )}>
            Content
        </div>
    );
};
```

### Chart Components

Use Recharts with dark theme styling:

```tsx
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

<ResponsiveContainer width="100%" height={300}>
    <BarChart data={data}>
        <XAxis dataKey="name" stroke="hsl(var(--muted-foreground))" />
        <YAxis stroke="hsl(var(--muted-foreground))" />
        <Tooltip
            contentStyle={{
                backgroundColor: 'hsl(var(--card))',
                border: '1px solid hsl(var(--border))'
            }}
        />
        <Bar dataKey="value" fill="hsl(var(--primary))" />
    </BarChart>
</ResponsiveContainer>
```

### Page Components

Page structure pattern:

```tsx
import { Helmet } from 'react-helmet-async';

export default function ProductionPage() {
    return (
        <>
            <Helmet>
                <title>Production | Satisfactory Dashboard</title>
            </Helmet>

            <div className="container mx-auto max-w-7xl p-6">
                <h1 className="text-2xl font-bold mb-6">
                    Production Overview
                </h1>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {/* Page content */}
                </div>
            </div>
        </>
    );
}
```

### Map Integration

Leaflet for interactive maps with dark theme styling:

```tsx
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import './leaflet-dark.css';

const FactoryMap = () => (
    <MapContainer center={[0, 0]} zoom={2} className="h-full w-full">
        <TileLayer url="..." />
        {markers.map(marker => (
            <Marker key={marker.id} position={marker.position}>
                <Popup className="dark-popup">{marker.name}</Popup>
            </Marker>
        ))}
    </MapContainer>
);
```

## Theme System

### Dark/Light Mode

The application uses CSS variables for theming with dark mode as default:

```tsx
// Access theme in components
import { useTheme } from '@/components/theme-provider';

const MyComponent = () => {
    const { theme, setTheme } = useTheme();

    return (
        <Button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}>
            Toggle Theme
        </Button>
    );
};
```

### CSS Variables

Defined in `src/index.css` using OKLCH color format:

```css
:root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    /* ... */
}

.dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    /* ... */
}
```

### Tailwind Typography

Use Tailwind utility classes for text styling:

```tsx
<h1 className="text-3xl font-bold tracking-tight">Heading</h1>
<p className="text-muted-foreground">Body text</p>
<span className="text-sm text-muted-foreground">Caption</span>
```

## Adding New Pages

1. **Create page component** in `pages/`:

   ```tsx
   // pages/new-feature.tsx
   import { Helmet } from 'react-helmet-async';

   export default function NewFeaturePage() {
       return (
           <>
               <Helmet>
                   <title>New Feature | Satisfactory Dashboard</title>
               </Helmet>
               <div className="container mx-auto max-w-7xl p-6">
                   {/* Page content */}
               </div>
           </>
       );
   }
   ```

2. **Add route** in `routes/sections.tsx`:

   ```tsx
   {
       path: 'new-feature',
       element: <NewFeaturePage />,
   }
   ```

3. **Add navigation** in `layouts/config-nav-dashboard.tsx`:
   ```tsx
   {
       title: 'New Feature',
       path: '/new-feature',
       icon: <Iconify icon="mdi:new-box" />,
       group: 'main',
   }
   ```

## Adding New Components

1. **For shadcn components**, install via CLI:

   ```bash
   bunx shadcn@latest add [component-name]
   ```

2. **For custom components**, create in appropriate directory:

   ```tsx
   // components/feature/FeatureCard.tsx
   import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

   interface FeatureCardProps {
       title: string;
       value: number;
   }

   /**
    * FeatureCard displays a feature metric with title and value.
    */
   export const FeatureCard = ({ title, value }: FeatureCardProps) => (
       <Card>
           <CardHeader className="pb-2">
               <CardTitle className="text-sm font-medium">{title}</CardTitle>
           </CardHeader>
           <CardContent>
               <div className="text-2xl font-bold">{value}</div>
           </CardContent>
       </Card>
   );
   ```

3. **Export** from component directory index if needed

4. **Use** in pages or sections

## Utility Functions

### Number Formatting

```tsx
import { fNumber, fShortenNumber, fPercent } from '../utils/format-number';

fNumber(1234567);        // "1,234,567"
fShortenNumber(1234567); // "1.2M"
fPercent(0.85);          // "85%"
```

### Time Formatting

```tsx
import { fTime, fDateTime } from '../utils/format-time';

fTime(new Date());       // "14:30"
fDateTime(new Date());   // "Jan 15, 2024 14:30"
```

### Abbreviations

```tsx
import { abbreviateUnit } from '../utils/abbreviations';

abbreviateUnit('megawatt');  // "MW"
abbreviateUnit('items/min'); // "i/m"
```

## Linting with oxlint

Fast Rust-based linter. Configuration is minimal - oxlint works out of the box:

```bash
bun run lint         # Check for issues
bun run lint:fix     # Auto-fix issues
```

## Formatting with oxfmt

Configuration in `.oxfmtrc.json`:

```json
{
  "printWidth": 100,
  "singleQuote": true,
  "trailingComma": "es5"
}
```

oxfmt is Prettier-compatible and 30x faster.

## Docker Build

```dockerfile
FROM oven/bun:1.3-slim AS build
WORKDIR /app
COPY package.json bun.lockb ./
RUN bun install --frozen-lockfile
COPY . .
ARG VITE_API_URL
RUN VITE_API_URL=$VITE_API_URL bun run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
```

## Important Notes

### State Management

- No complex client-side state management
- Backend is source of truth
- Real-time updates via SSE
- Use React Context for shared state
- Sessions stored in Redis on backend

### No Backward Compatibility

**NEVER maintain backward compatibility.** Always do the correct fix for a better system.

When refactoring or improving code:
- Remove old code completely instead of keeping it for compatibility
- If a data format changes, migrate immediately - don't support both formats
- Write migration scripts if needed, but don't maintain dual code paths
- Trust that all instances will be updated together in a coordinated deployment
- Simpler code is better than maintaining legacy compatibility layers

### Radix UI Triggers (DropdownMenu, Popover, etc.)

**NEVER use `asChild` with custom components** like `Button` on Radix UI triggers (`DropdownMenuTrigger`, `PopoverTrigger`, etc.). This breaks Radix Popper's position calculations with Tailwind CSS v4, causing dropdowns/popovers to appear at position (0,0) off-screen.

**Correct approach** - style the trigger directly:
```tsx
// ✅ GOOD - style the trigger directly, no asChild
<DropdownMenuTrigger className="inline-flex h-9 items-center justify-center rounded-md border border-input bg-background px-3 text-sm hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring">
  Click me
  <ChevronDown className="ml-2 size-4" />
</DropdownMenuTrigger>

// ✅ GOOD - for icon buttons
<PopoverTrigger className="inline-flex size-8 items-center justify-center rounded-md border border-input bg-popover/90 hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring">
  <Icon icon="mdi:layers" className="size-5" />
</PopoverTrigger>
```

**Incorrect approach** - do NOT do this:
```tsx
// ❌ BAD - asChild with Button breaks positioning
<DropdownMenuTrigger asChild>
  <Button variant="outline">Click me</Button>
</DropdownMenuTrigger>
```

### Performance

- Memoize expensive calculations with `useMemo`
- Use `React.memo` for components that don't need frequent re-renders
- Lazy load pages with `React.lazy`

### Error Handling

- Always handle loading and error states
- Use shadcn Alert components for error display
- Use Sonner toast for notifications
- Log errors for debugging

### Accessibility

- Use semantic HTML elements
- Include ARIA labels where needed
- Ensure keyboard navigation works
- Test with screen readers

## Related Documentation

- **Root CLAUDE.md**: Full-stack architecture overview
- **api/CLAUDE.md**: Backend API architecture
- **shadcn/ui docs**: https://ui.shadcn.com/
- **Tailwind CSS v4 docs**: https://tailwindcss.com/
- **Vite docs**: https://vitejs.dev/
- **Bun docs**: https://bun.sh/docs
- **oxlint docs**: https://oxc.rs/docs/guide/usage/linter.html
- **oxfmt docs**: https://oxc.rs/docs/guide/usage/formatter.html
