# Commander - Frontend Dashboard

This document provides guidance for working with the React frontend application.

## Overview

React-based dashboard for monitoring Satisfactory factory operations. Features real-time data visualization with charts, interactive maps, and live updates via Server-Sent Events.

## Tech Stack

- **Bun 1.3** for package management and runtime
- **React 18** with TypeScript 5.6
- **Vite 5** for build and dev server
- **Material-UI 6** for UI components
- **React Router 6** for client-side routing
- **MUI X Charts + Recharts** for data visualization
- **Leaflet + React Leaflet** for interactive maps
- **styled-components** for custom styling
- **Day.js** for date formatting
- **oxlint** for linting
- **oxfmt** for code formatting

## Architecture

### Directory Structure

```
commander/src/
├── pages/                    # Page components (home, map, production, power, trains, drones, players, settings)
├── components/               # Reusable components
│   ├── color-utils/         # Color picker and preview
│   ├── iconify/             # Iconify icon integration
│   ├── label/               # Label/badge components
│   ├── logo/                # App logo component
│   ├── scrollbar/           # Custom scrollbar
│   ├── session-dialog/      # Add session dialog
│   ├── session-selector/    # Session dropdown selector
│   ├── session-status-bar/  # Session status indicator
│   ├── svg-color/           # SVG color utilities
│   └── welcome/             # Welcome screen for new users
├── contexts/                 # React Context
│   ├── api/                 # API data provider (SSE streaming)
│   └── sessions/            # Session management context
├── layouts/                  # Layout components
│   ├── components/          # Layout components
│   ├── core/                # Core layout utilities
│   ├── dashboard/           # Main dashboard layout
│   └── simple/              # Simple layouts (no sidebar)
├── routes/                   # Routing configuration
│   ├── components/          # Route-level components
│   └── hooks/               # Routing hooks
├── sections/                 # Feature sections (page-specific components)
│   ├── drones/              # Drone views
│   ├── error/               # Error pages
│   ├── map/                 # Map views
│   ├── overview/            # Overview/dashboard views
│   ├── players/             # Player views
│   ├── power/               # Power circuit views
│   ├── production/          # Production views
│   ├── settings/            # Settings views
│   └── trains/              # Train views
├── services/                 # API services (session CRUD)
├── theme/                    # Material-UI theme
│   ├── core/                # Theme configuration (palette, typography, shadows)
│   └── styles/              # Global and mixin styles
├── hooks/                    # Custom React hooks
└── utils/                    # Utility functions (formatting, abbreviations)
```

## Development Workflow

### Running the Dev Server

```bash
bun run dev          # Start Vite dev server (port 3039)
bun run dev:host     # Dev server with host binding (for network access)
```

### Building

```bash
bun run build        # TypeScript check + production build
```

Output: `dist/` directory

### Code Quality

```bash
bun run lint         # oxlint check
bun run lint:fix     # oxlint auto-fix
bun run format       # oxfmt format check
bun run format:fix   # oxfmt format and write
bun run check        # Full check (oxlint + oxfmt)
bun run check:fix    # Fix all (oxlint + oxfmt)
```

## Key Development Patterns

### Type Safety

Use auto-generated types from backend:

```tsx
import { Circuit, Drone, Train, Player, Session } from '../apiTypes';

interface Props {
    circuits: Circuit[];
    drones: Drone[];
}
```

Types generated by `tygo` from Go structs. Run `make generate` from project root after backend model changes.

### Session Context

Multi-session support via SessionContext:

```tsx
import { useSession } from 'src/contexts/sessions';

const MyComponent = () => {
    const { sessions, selectedSession, selectSession, createSession } = useSession();

    return (
        <div>
            <p>Current: {selectedSession?.name}</p>
            <button onClick={() => selectSession(sessions[0].id)}>
                Switch Session
            </button>
        </div>
    );
};
```

### API Context

Data fetching via React Context with session-scoped SSE:

```tsx
import { useContextSelector } from 'use-context-selector';
import { ApiContext } from 'src/contexts/api/useApi';

const MyComponent = () => {
    const api = useContextSelector(ApiContext, (v) => ({
        circuits: v.circuits,
        isLoading: v.isLoading,
        isOnline: v.isOnline,
    }));

    if (api.isLoading) return <CircularProgress />;
    if (!api.isOnline) return <Alert severity="error">Offline</Alert>;

    return <DataDisplay data={api.circuits} />;
};
```

### SSE Integration

Real-time updates via Server-Sent Events (session-scoped):

```tsx
// ApiProvider connects to /v1/sessions/{sessionId}/events
// and updates context automatically
```

### Material-UI Components

Use MUI components with theme customization:

```tsx
import { Box, Card, Typography, useTheme } from '@mui/material';

const MyComponent = () => {
    const theme = useTheme();

    return (
        <Card sx={{ p: 3, bgcolor: theme.palette.background.paper }}>
            <Typography variant="h6">Title</Typography>
            <Box sx={{ display: 'flex', gap: 2, mt: 2 }}>
                {/* Content */}
            </Box>
        </Card>
    );
};
```

### Chart Components

Wrapper components for chart libraries:

```tsx
import { Chart } from '../components/chart';

<Chart
    type="line"
    series={[{ name: 'Power', data: powerData }]}
    options={{
        xaxis: { categories: timeLabels },
        colors: [theme.palette.primary.main]
    }}
    height={300}
/>
```

### Page Components

Page structure pattern:

```tsx
import { Helmet } from 'react-helmet-async';
import { Container, Typography, Grid } from '@mui/material';

export default function ProductionPage() {
    return (
        <>
            <Helmet>
                <title>Production | Commander</title>
            </Helmet>

            <Container maxWidth="xl">
                <Typography variant="h4" sx={{ mb: 5 }}>
                    Production Overview
                </Typography>

                <Grid container spacing={3}>
                    {/* Page content */}
                </Grid>
            </Container>
        </>
    );
}
```

### Map Integration

Leaflet for interactive maps:

```tsx
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';

const FactoryMap = () => (
    <MapContainer center={[0, 0]} zoom={2} style={{ height: '100%' }}>
        <TileLayer url="..." />
        {markers.map(marker => (
            <Marker key={marker.id} position={marker.position}>
                <Popup>{marker.name}</Popup>
            </Marker>
        ))}
    </MapContainer>
);
```

## Theme Customization

### Colors

Defined in `theme/colors.json` and applied via `theme/core/palette.ts`:

```typescript
// Access theme colors
const theme = useTheme();
theme.palette.primary.main
theme.palette.background.paper
theme.palette.text.primary
```

### Typography

Configured in `theme/core/typography.ts`:

```tsx
<Typography variant="h1">Heading</Typography>
<Typography variant="body1">Body text</Typography>
<Typography variant="caption">Caption</Typography>
```

### Shadows

Defined in `theme/core/shadows.ts`:

```tsx
<Card sx={{ boxShadow: theme.shadows[3] }}>
```

## Adding New Pages

1. **Create page component** in `pages/`:

   ```tsx
   // pages/new-feature.tsx
   import { Helmet } from 'react-helmet-async';
   import { Container } from '@mui/material';

   export default function NewFeaturePage() {
       return (
           <>
               <Helmet>
                   <title>New Feature | Commander</title>
               </Helmet>
               <Container maxWidth="xl">
                   {/* Page content */}
               </Container>
           </>
       );
   }
   ```

2. **Add route** in `routes/sections.tsx`:

   ```tsx
   {
       path: 'new-feature',
       element: <NewFeaturePage />,
   }
   ```

3. **Add navigation** in `layouts/config-nav-dashboard.tsx`:
   ```tsx
   {
       title: 'New Feature',
       path: '/new-feature',
       icon: <Iconify icon="mdi:new-box" />,
       group: 'main',
   }
   ```

## Adding New Components

1. **Create component** in appropriate directory:

   ```tsx
   // components/feature/FeatureCard.tsx
   import { Card, CardContent, Typography } from '@mui/material';

   interface FeatureCardProps {
       title: string;
       value: number;
   }

   export const FeatureCard = ({ title, value }: FeatureCardProps) => (
       <Card>
           <CardContent>
               <Typography variant="subtitle2">{title}</Typography>
               <Typography variant="h4">{value}</Typography>
           </CardContent>
       </Card>
   );
   ```

2. **Export** from component directory index if needed

3. **Use** in pages or sections

## Utility Functions

### Number Formatting

```tsx
import { fNumber, fShortenNumber, fPercent } from '../utils/format-number';

fNumber(1234567);        // "1,234,567"
fShortenNumber(1234567); // "1.2M"
fPercent(0.85);          // "85%"
```

### Time Formatting

```tsx
import { fTime, fDateTime } from '../utils/format-time';

fTime(new Date());       // "14:30"
fDateTime(new Date());   // "Jan 15, 2024 14:30"
```

### Abbreviations

```tsx
import { abbreviateUnit } from '../utils/abbreviations';

abbreviateUnit('megawatt');  // "MW"
abbreviateUnit('items/min'); // "i/m"
```

## Linting with oxlint

Fast Rust-based linter. Configuration is minimal - oxlint works out of the box:

```bash
bun run lint         # Check for issues
bun run lint:fix     # Auto-fix issues
```

## Formatting with oxfmt

Configuration in `.oxfmtrc.json`:

```json
{
  "printWidth": 100,
  "singleQuote": true,
  "trailingComma": "es5"
}
```

oxfmt is Prettier-compatible and 30x faster.

## Docker Build

```dockerfile
FROM oven/bun:1.3-slim AS build
WORKDIR /app
COPY package.json bun.lockb ./
RUN bun install --frozen-lockfile
COPY . .
ARG VITE_API_URL
RUN VITE_API_URL=$VITE_API_URL bun run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
```

## Important Notes

### State Management

- No complex client-side state management
- Backend is source of truth
- Real-time updates via SSE
- Use React Context for shared state
- Sessions stored in Redis on backend

### Performance

- Memoize expensive calculations with `useMemo`
- Use `React.memo` for components that don't need frequent re-renders
- Lazy load pages with `React.lazy`

### Error Handling

- Always handle loading and error states
- Use MUI Alert components for error display
- Log errors for debugging

### Accessibility

- Use semantic HTML elements
- Include ARIA labels where needed
- Ensure keyboard navigation works
- Test with screen readers

## Related Documentation

- **Root CLAUDE.md**: Full-stack architecture overview
- **api/CLAUDE.md**: Backend API architecture
- **Material-UI docs**: https://mui.com/
- **Vite docs**: https://vitejs.dev/
- **Bun docs**: https://bun.sh/docs
- **oxlint docs**: https://oxc.rs/docs/guide/usage/linter.html
- **oxfmt docs**: https://oxc.rs/docs/guide/usage/formatter.html
